FROM apache/airflow:2.7.0

USER root

# Install system dependencies
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
        build-essential \
        curl \
        git \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

USER airflow

# Install Airflow providers and dependencies
RUN pip install --no-cache-dir \
    apache-airflow-providers-postgres \
    apache-airflow-providers-amazon \
    boto3 \
    arxiv \
    openai \
    pinecone-client \
    tiktoken \
    PyMuPDF

# Copy Airflow-specific requirements
COPY --chown=airflow:root requirements.airflow.txt /requirements.airflow.txt

# Install Python dependencies for Airflow
RUN pip install --no-cache-dir -r /requirements.airflow.txt

# Set working directory
WORKDIR /opt/airflow

# Copy dags directory
COPY --chown=airflow:root dags/ /opt/airflow/dags/

# Set PYTHONPATH to include project root
ENV PYTHONPATH=/opt/airflow:/opt/airflow/dags:${PYTHONPATH}
